<!DOCTYPE html>
<html>
<head>
    <title>RFID Simulator Test</title>
    <style>
        body { font-family: Arial; padding: 20px; background: #f5f5f5; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #2c3e50; }
        .form-group { margin: 15px 0; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        button { background: #3498db; color: white; padding: 12px 24px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }
        button:hover { background: #2980b9; }
        button:disabled { background: #95a5a6; cursor: not-allowed; }
        .result { margin-top: 20px; padding: 15px; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .logs { margin-top: 20px; }
        .logs table { width: 100%; border-collapse: collapse; }
        .logs th, .logs td { padding: 8px; border: 1px solid #ddd; text-align: left; }
        .logs th { background: #f8f9fa; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸŽ® RFID Simulator Test</h1>
        <p>Test if RFID simulator correctly creates logs in recent_logs table</p>
        
        <div class="form-group">
            <label>Select Vehicle:</label>
            <select id="vehicleSelect">
                <option value="">-- Select a vehicle --</option>
            </select>
        </div>
        
        <div class="form-group">
            <button id="scanBtn" disabled>ðŸ“¡ Simulate RFID Scan</button>
            <button id="checkLogsBtn" style="background: #2ecc71;">ðŸ“‹ Check Recent Logs</button>
        </div>
        
        <div id="result"></div>
        
        <div class="logs" id="logsContainer" style="display: none;">
            <h3>Recent Logs (from recent_logs table)</h3>
            <table>
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Plate</th>
                        <th>Status</th>
                        <th>Created At</th>
                    </tr>
                </thead>
                <tbody id="logsTable"></tbody>
            </table>
        </div>
    </div>
    
    <script>
        const vehicleSelect = document.getElementById('vehicleSelect');
        const scanBtn = document.getElementById('scanBtn');
        const checkLogsBtn = document.getElementById('checkLogsBtn');
        const result = document.getElementById('result');
        const logsContainer = document.getElementById('logsContainer');
        const logsTable = document.getElementById('logsTable');
        
        // Load homeowners
        async function loadVehicles() {
            try {
                const res = await fetch('../api/homeowners_get.php');
                const data = await res.json();
                const homeowners = Array.isArray(data) ? data : (data.data || []);
                
                homeowners.forEach(h => {
                    const option = document.createElement('option');
                    option.value = h.plate_number;
                    option.textContent = `${h.plate_number} - ${h.name} (${h.vehicle_type || 'N/A'})`;
                    vehicleSelect.appendChild(option);
                });
                
                showResult('Loaded ' + homeowners.length + ' vehicles', 'info');
            } catch (err) {
                showResult('Error loading vehicles: ' + err.message, 'error');
            }
        }
        
        vehicleSelect.addEventListener('change', () => {
            scanBtn.disabled = !vehicleSelect.value;
        });
        
        scanBtn.addEventListener('click', async () => {
            const plate = vehicleSelect.value;
            if (!plate) return;
            
            scanBtn.disabled = true;
            scanBtn.textContent = 'ðŸ”„ Scanning...';
            
            try {
                const res = await fetch('../admin/simulate_rfid_scan.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: 'plate_number=' + encodeURIComponent(plate)
                });
                
                const json = await res.json();
                
                if (json.success) {
                    showResult(
                        `âœ… Success!<br>` +
                        `<strong>Plate:</strong> ${json.plate}<br>` +
                        `<strong>Owner:</strong> ${json.name}<br>` +
                        `<strong>Status:</strong> ${json.status}<br>` +
                        `<strong>Message:</strong> ${json.message}`,
                        'success'
                    );
                    
                    // Auto-refresh logs after 500ms
                    setTimeout(checkLogs, 500);
                } else {
                    showResult('âŒ Error: ' + json.message, 'error');
                }
            } catch (err) {
                showResult('âŒ Request failed: ' + err.message, 'error');
            } finally {
                scanBtn.disabled = false;
                scanBtn.textContent = 'ðŸ“¡ Simulate RFID Scan';
            }
        });
        
        checkLogsBtn.addEventListener('click', checkLogs);
        
        async function checkLogs() {
            try {
                const res = await fetch('../guard/pages/fetch_logs.php');
                const logs = await res.json();
                
                if (Array.isArray(logs)) {
                    logsContainer.style.display = 'block';
                    logsTable.innerHTML = logs.map(log => `
                        <tr>
                            <td>${log.time || log.log_time || '-'}</td>
                            <td>${log.plate_number}</td>
                            <td>${log.status}</td>
                            <td>${log.created_at || log.log_time_raw || '-'}</td>
                        </tr>
                    `).join('');
                    
                    showResult(`ðŸ“‹ Fetched ${logs.length} recent logs`, 'info');
                } else {
                    showResult('Unexpected response from logs API', 'error');
                }
            } catch (err) {
                showResult('Error fetching logs: ' + err.message, 'error');
            }
        }
        
        function showResult(message, type) {
            result.innerHTML = `<div class="result ${type}">${message}</div>`;
        }
        
        // Initialize
        loadVehicles();
        checkLogs();
    </script>
</body>
</html>
