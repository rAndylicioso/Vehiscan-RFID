<!DOCTYPE html>
<html>
<head>
    <title>Guard Logs Direct Test</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1e1e1e; color: #d4d4d4; }
        h1 { color: #4ec9b0; }
        button { padding: 10px 20px; margin: 10px 5px; background: #0e639c; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #1177bb; }
        .result { margin: 20px 0; padding: 15px; background: #252526; border-radius: 4px; }
        .success { border-left: 4px solid #4ec9b0; }
        .error { border-left: 4px solid #f48771; }
        pre { background: #1e1e1e; padding: 10px; overflow-x: auto; border: 1px solid #3c3c3c; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { padding: 8px; text-align: left; border: 1px solid #3c3c3c; }
        th { background: #2d2d30; color: #4fc1ff; }
        .status-in { color: #4ec9b0; }
        .status-out { color: #f48771; }
    </style>
</head>
<body>
    <h1>üîç Guard Panel Logs - Direct Test</h1>
    <p>Testing if guard panel can fetch logs from the database</p>
    
    <div>
        <button onclick="testFetchLogs()">üìã Fetch Logs</button>
        <button onclick="testInsertLog()">‚ûï Insert Test Log</button>
        <button onclick="clearResults()">üóëÔ∏è Clear</button>
    </div>
    
    <div id="results"></div>
    
    <script>
        const resultsDiv = document.getElementById('results');
        
        function clearResults() {
            resultsDiv.innerHTML = '';
        }
        
        async function testFetchLogs() {
            addResult('Fetching logs from guard/pages/fetch_logs.php...', 'info');
            
            try {
                const response = await fetch('../guard/pages/fetch_logs.php?_=' + Date.now());
                const status = response.status;
                
                addResult(`Response Status: ${status}`, status === 200 ? 'success' : 'error');
                
                if (!response.ok) {
                    const text = await response.text();
                    addResult(`Error Response: ${text}`, 'error');
                    return;
                }
                
                const logs = await response.json();
                
                addResult(`‚úÖ Successfully fetched ${logs.length} logs`, 'success');
                
                if (Array.isArray(logs) && logs.length > 0) {
                    let table = '<table><thead><tr><th>Time</th><th>Plate</th><th>Status</th><th>Name</th></tr></thead><tbody>';
                    logs.forEach(log => {
                        const statusClass = log.status === 'IN' ? 'status-in' : 'status-out';
                        table += `<tr>
                            <td>${log.time || '-'}</td>
                            <td>${log.plate_number || '-'}</td>
                            <td class="${statusClass}">${log.status || '-'}</td>
                            <td>${log.name || 'Unknown'}</td>
                        </tr>`;
                    });
                    table += '</tbody></table>';
                    addResult(table, 'success');
                    
                    addResult('<strong>Raw JSON:</strong><pre>' + JSON.stringify(logs, null, 2) + '</pre>', 'success');
                } else {
                    addResult('No logs found in response', 'error');
                }
                
            } catch (error) {
                addResult(`‚ùå Fetch Error: ${error.message}`, 'error');
                console.error(error);
            }
        }
        
        async function testInsertLog() {
            addResult('Simulating RFID scan...', 'info');
            
            try {
                // First get a homeowner
                const homeownersRes = await fetch('../api/homeowners_get.php');
                const homeowners = await homeownersRes.json();
                const testHomeowner = Array.isArray(homeowners) ? homeowners[0] : homeowners.data[0];
                
                if (!testHomeowner) {
                    addResult('‚ùå No homeowners found to test with', 'error');
                    return;
                }
                
                addResult(`Testing with: ${testHomeowner.plate_number} (${testHomeowner.name})`, 'info');
                
                // Simulate RFID scan
                const response = await fetch('../admin/simulate_rfid_scan.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: 'plate_number=' + encodeURIComponent(testHomeowner.plate_number)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    addResult(`‚úÖ Scan simulated successfully!`, 'success');
                    addResult(`Plate: ${result.plate}, Owner: ${result.name}`, 'success');
                    
                    // Auto-fetch logs after 1 second
                    setTimeout(() => {
                        addResult('Auto-fetching logs to verify...', 'info');
                        testFetchLogs();
                    }, 1000);
                } else {
                    addResult(`‚ùå Simulation failed: ${result.message}`, 'error');
                }
                
            } catch (error) {
                addResult(`‚ùå Error: ${error.message}`, 'error');
                console.error(error);
            }
        }
        
        function addResult(message, type = 'info') {
            const div = document.createElement('div');
            div.className = 'result ' + type;
            div.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
            resultsDiv.appendChild(div);
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }
        
        // Auto-load logs on page load
        window.addEventListener('load', () => {
            addResult('Page loaded - Testing guard logs fetch...', 'info');
            testFetchLogs();
        });
    </script>
</body>
</html>
