<!DOCTYPE html>
<html>
<head>
    <title>Fixed Issues Test</title>
    <style>
        body { font-family: Arial; padding: 20px; background: #f5f5f5; }
        .test { background: white; padding: 20px; margin: 10px 0; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .pass { border-left: 5px solid #28a745; }
        .fail { border-left: 5px solid #dc3545; }
        h1 { color: #333; }
        h2 { color: #666; font-size: 18px; margin-top: 0; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 3px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        .status { font-weight: bold; font-size: 16px; margin: 10px 0; }
        pre { background: #272822; color: #f8f8f2; padding: 10px; border-radius: 3px; overflow-x: auto; font-size: 12px; }
        .info { background: #d1ecf1; color: #0c5460; padding: 10px; border-radius: 3px; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>üîß Issues Fixed - Test Results</h1>
    
    <div class="info">
        <strong>Fixed Issues:</strong>
        <ul>
            <li>‚úÖ Account Approvals now work for both admin and super_admin</li>
            <li>‚úÖ Guard logout button ID corrected (signOutBtn)</li>
            <li>‚úÖ Visitor Passes SQL query simplified (removed problematic columns)</li>
        </ul>
    </div>
    
    <div class="test">
        <h2>Test 1: Account Approvals Authorization</h2>
        <button onclick="testApprovals()">Test Approvals API</button>
        <div id="approvals-result"></div>
    </div>
    
    <div class="test">
        <h2>Test 2: Guard Visitor Passes</h2>
        <button onclick="testVisitorPasses()">Test Visitor Passes</button>
        <div id="visitor-result"></div>
    </div>
    
    <div class="test">
        <h2>Test 3: All Admin Endpoints</h2>
        <button onclick="testAllEndpoints()">Run Full Test</button>
        <div id="full-test-result"></div>
    </div>

    <script>
        async function testApprovals() {
            const resultDiv = document.getElementById('approvals-result');
            resultDiv.innerHTML = '<p>Testing Account Approvals API...</p>';
            
            try {
                // First check if we can access the approvals page
                const pageResponse = await fetch('../admin/fetch/fetch_approvals.php');
                const pageStatus = pageResponse.status;
                
                let html = '<div class="status">';
                if (pageStatus === 200) {
                    html += '‚úÖ <span style="color: green;">Approvals Page: OK (200)</span>';
                } else if (pageStatus === 403) {
                    html += '‚ùå <span style="color: red;">Approvals Page: Forbidden (403)</span>';
                    html += '<p>Please make sure you are logged in as admin or super_admin</p>';
                } else {
                    html += '‚ö†Ô∏è <span style="color: orange;">Approvals Page: ' + pageStatus + '</span>';
                }
                html += '</div>';
                
                // Test the pending accounts API
                const apiResponse = await fetch('../admin/api/get_pending_accounts.php');
                const apiStatus = apiResponse.status;
                
                html += '<div class="status">';
                if (apiStatus === 200) {
                    const data = await apiResponse.json();
                    html += '‚úÖ <span style="color: green;">Pending Accounts API: OK</span>';
                    html += '<p>Found ' + (data.accounts ? data.accounts.length : 0) + ' pending accounts</p>';
                } else if (apiStatus === 403) {
                    html += '‚ùå <span style="color: red;">API: Forbidden (403)</span>';
                } else {
                    html += '‚ö†Ô∏è <span style="color: orange;">API Status: ' + apiStatus + '</span>';
                }
                html += '</div>';
                
                resultDiv.innerHTML = html;
            } catch (error) {
                resultDiv.innerHTML = '<div class="status">‚ùå <span style="color: red;">Error: ' + error.message + '</span></div>';
            }
        }
        
        async function testVisitorPasses() {
            const resultDiv = document.getElementById('visitor-result');
            resultDiv.innerHTML = '<p>Testing Visitor Passes API...</p>';
            
            try {
                const response = await fetch('../guard/fetch/fetch_visitors.php');
                const status = response.status;
                const contentType = response.headers.get('content-type');
                
                let html = '<div class="status">';
                if (status === 200) {
                    html += '‚úÖ <span style="color: green;">Visitor Passes: OK (200)</span>';
                    
                    if (contentType && contentType.includes('application/json')) {
                        const data = await response.json();
                        if (data.success) {
                            html += '<p>Successfully fetched ' + (data.count || 0) + ' visitor passes</p>';
                            html += '<p style="color: green;">‚úì No SQL errors!</p>';
                        } else {
                            html += '<p style="color: orange;">API returned success=false: ' + (data.error || 'Unknown error') + '</p>';
                        }
                    } else {
                        html += '<p style="color: orange;">Response is not JSON (might be HTML error page)</p>';
                    }
                } else if (status === 401) {
                    html += '‚ö†Ô∏è <span style="color: orange;">Unauthorized (401) - You need to be logged in as guard</span>';
                } else if (status === 500) {
                    html += '‚ùå <span style="color: red;">Server Error (500) - SQL Error</span>';
                    const text = await response.text();
                    html += '<pre>' + text.substring(0, 500) + '</pre>';
                } else {
                    html += '‚ö†Ô∏è <span style="color: orange;">Status: ' + status + '</span>';
                }
                html += '</div>';
                
                resultDiv.innerHTML = html;
            } catch (error) {
                resultDiv.innerHTML = '<div class="status">‚ùå <span style="color: red;">Error: ' + error.message + '</span></div>';
            }
        }
        
        async function testAllEndpoints() {
            const resultDiv = document.getElementById('full-test-result');
            resultDiv.innerHTML = '<p>Running comprehensive tests...</p>';
            
            const endpoints = [
                { name: 'Admin Dashboard', url: '../admin/fetch/fetch_dashboard.php', expectedRole: 'admin' },
                { name: 'Account Approvals Page', url: '../admin/fetch/fetch_approvals.php', expectedRole: 'admin' },
                { name: 'Pending Accounts API', url: '../admin/api/get_pending_accounts.php', expectedRole: 'admin' },
                { name: 'Employees', url: '../admin/fetch/fetch_employees.php', expectedRole: 'admin' },
                { name: 'Visitors (Admin)', url: '../admin/fetch/fetch_visitors.php', expectedRole: 'admin' },
                { name: 'Logs', url: '../admin/fetch/fetch_logs.php', expectedRole: 'admin' },
                { name: 'Visitor Passes (Guard)', url: '../guard/fetch/fetch_visitors.php', expectedRole: 'guard' }
            ];
            
            let html = '<table style="width:100%; border-collapse: collapse;">';
            html += '<tr><th style="text-align:left; padding:8px; border-bottom:2px solid #ddd;">Endpoint</th><th style="text-align:left; padding:8px; border-bottom:2px solid #ddd;">Status</th><th style="text-align:left; padding:8px; border-bottom:2px solid #ddd;">Result</th></tr>';
            
            for (const endpoint of endpoints) {
                try {
                    const response = await fetch(endpoint.url);
                    const status = response.status;
                    
                    let statusColor = 'orange';
                    let statusText = status;
                    let result = '';
                    
                    if (status === 200) {
                        statusColor = 'green';
                        statusText = '‚úÖ ' + status;
                        result = 'Working';
                    } else if (status === 403 || status === 401) {
                        statusColor = 'orange';
                        statusText = '‚ö†Ô∏è ' + status;
                        result = 'Not logged in as ' + endpoint.expectedRole;
                    } else {
                        statusColor = 'red';
                        statusText = '‚ùå ' + status;
                        result = 'Error';
                    }
                    
                    html += `<tr>
                        <td style="padding:8px; border-bottom:1px solid #eee;">${endpoint.name}</td>
                        <td style="padding:8px; border-bottom:1px solid #eee; color:${statusColor}; font-weight:bold;">${statusText}</td>
                        <td style="padding:8px; border-bottom:1px solid #eee;">${result}</td>
                    </tr>`;
                } catch (error) {
                    html += `<tr>
                        <td style="padding:8px; border-bottom:1px solid #eee;">${endpoint.name}</td>
                        <td style="padding:8px; border-bottom:1px solid #eee; color:red;">‚ùå Error</td>
                        <td style="padding:8px; border-bottom:1px solid #eee;">${error.message}</td>
                    </tr>`;
                }
            }
            
            html += '</table>';
            resultDiv.innerHTML = html;
        }
    </script>
</body>
</html>
